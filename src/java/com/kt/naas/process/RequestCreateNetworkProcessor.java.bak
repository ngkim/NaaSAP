package com.kt.naas.process;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.io.StringWriter;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Random;
import java.util.UUID;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;

import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import com.kt.naas.db.DaoFactory;
import com.kt.naas.db.NetworkServiceDao;
import com.kt.naas.db.ProgressStatusDao;
import com.kt.naas.domain.NetworkService;
import com.kt.naas.domain.FieldBuffer;
import com.kt.naas.domain.NetworkServiceRequest;
import com.kt.naas.domain.ProgressStatus;
import com.kt.naas.domain.TenantNetworkInfo;
import com.kt.naas.util.RequestClient;
import com.kt.naas.xml.CloudConnectionList;
import com.kt.naas.xml.CloudSwitch;
import com.kt.naas.xml.CloudVNID;
import com.kt.naas.xml.RequestCreateCloudNetwork;
import com.kt.naas.xml.RequestCreatePremiseNetwork;
import com.kt.naas.xml.RequestInfoCloudSDNConnnection;
import com.kt.naas.xml.ResponseCreateCloudNetwork;
import com.kt.naas.xml.ResponseCreatePremiseNetwork;

public class RequestCreateNetworkProcessor extends RequestProcessor {
	private final Logger logger = LoggerFactory.getLogger(getClass());

	private final String cloudUrl = "http://210.183.241.184:5000/createCloudSDNConnection";
	private final String premiseUrl = "http://211.224.204.137:8080/NaaS/api.updatePremiseSDNConnection";
	private final String transportUrl = "http://211.224.204.137:8080/NaaS/api.createTransportEthernetConnection";

	@Autowired
	RequestClient requestClient;

	RequestCreateCloudNetwork reqCloud;
	RequestCreatePremiseNetwork reqPremise;

	private String generateUUID() {
		UUID uuid = UUID.randomUUID();
		return uuid.toString();
	}

	public void printResponseCreateCloudNetwork(ResponseCreateCloudNetwork res) {
		try {
			System.out.println("RETURN CODE= " + res.getReturnCode());
			System.out.println("RETURN MSG= " + res.getMessage());
			System.out.println();
			System.out.println("DCSVCID= " + res.getDcsvcid());
			System.out.println("TENANTNAME= " + res.getTenantname());
			System.out.println("TENANTID= " + res.getTenantid());

			ArrayList<CloudVNID> list = res.getVNIDInfo();
			if (list != null) {
				for (int i = 0; i < list.size(); i++) {
					CloudVNID item = list.get(i);
					System.out.println("\tNWNAME= " + item.getName());
					System.out.println("\tVNID= " + item.getVNID());
					System.out.println("\tSUBNET= " + item.getSubnet());
					System.out.println("\tBW= " + item.getBandwidth());

					CloudConnectionList conList = item.getConnectionList();
					if (conList != null) {
						ArrayList<CloudSwitch> swlist = conList
								.getConnectionInfo();
						if (swlist != null) {
							for (int j = 0; j < swlist.size(); j++) {
								CloudSwitch sw = swlist.get(j);
								System.out.println("\t\tSWNAME= "
										+ sw.getName());
								System.out.println("\t\tSWID= " + sw.getDpid());
								System.out.println("\t\tSWType= "
										+ sw.getType());
								System.out.println("\t\tUpPort= "
										+ sw.getUplinkport());
								System.out.println("\t\tDownPort= "
										+ sw.getDownlinkport());
							}
						}
					}
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// Execute VLAN Swapping for a given port to a target vlan
	public void vlanSwap(String snmp_agent, String port_id_to_swap,
			int target_vlan) {

		String cmd_vlan_swap = "";
		cmd_vlan_swap = "snmpset -v 2c -c private " + snmp_agent + " vmVlan."
				+ port_id_to_swap + " integer " + target_vlan;

		Process p;
		String s = null;
		try {
			p = Runtime.getRuntime().exec(cmd_vlan_swap);
			BufferedReader br = new BufferedReader(new InputStreamReader(
					p.getInputStream()));

			while ((s = br.readLine()) != null)
				System.out.println("line: " + s);
			p.waitFor();

			p.destroy();
		} catch (Exception e) {
		}

	}

	@Override
	public void processRequest() {
		// generate a new id
		String svcId = generateUUID();

		int currentCnt = 0;
		int totalCnt = 7;

		// Receive request from WAS and Send it to API Server
		HttpResponse res = null;
		NetworkServiceRequest svcReq = null;
		try {
			svcReq = recvRequestfromWeb();
			updateNetworkServiceTable(svcId, svcReq);

			// Notify current progress to Web
			updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
					totalCnt, "네트워크 생성 요청을 준비 중입니다.");

			int reqDomain = 0; // 1: DC, 2: Premise
			String requestXml = "";
			ArrayList<TenantNetworkInfo> tnList = svcReq.getNetworklist();
			System.out.println("tnList.size" + tnList.size());
			for (int i = 0; i < tnList.size(); i++) {
				TenantNetworkInfo tn = tnList.get(i);

				// Request Create Cloud Network
				if (tn.getDcId() != null) {
					reqDomain = 1; // Set Request Domain as DC
					System.out.println("Request create Cloud Network");

					// RequestCreateCloudNetwork req = new
					// RequestCreateCloudNetwork();
					// req.setTenantName(tn.getTenantName());
					// req.setQos(svcReq.getBandwidth()); // QoS로 설정할 수 있는 값이
					// BW뿐임
					// req.setVnid("1024"); // TODO: DC 선택 시에 Web으로부터 VNID가 넘어와야
					// 함

					RequestInfoCloudSDNConnnection req = new RequestInfoCloudSDNConnnection();

					// TODO: ngkim - Tid and Vnid should be changed into human
					// readable format
					req.setTid("e84ea728cd134dea9110df0c2e9398b0");
					req.setVnid("c59c6de5-9a6e-4f30-bc58-3e66d2f95649");
					req.setBw(svcReq.getBandwidth());

					requestXml = getRequestCreateCloudNWXML(req);

					//res = requestToAPIServer(reqDomain, requestXml);

					updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
							totalCnt, "Cloud SDN에 Network 생성을 요청하였습니다.");

					// NGKIM - temp comment 
					// String responseXml = getResponseXml(res);
					String responseXml = "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?><ResponseInfo><ReturnCode>200</ReturnCode><ReturnCodeDescription>Success</ReturnCodeDescription><DcSvcId>PSDN000001</DcSvcId><TenantId>0be2a9fc8a7040d8963c9f67f521bdab</TenantId><TenantName>cloudsdn</TenantName><NetworkList><NetworkName>net_sdn</NetworkName>	<Subnet>10.1.1.0/24</Subnet>	<VLANID>10</VLANID>	<Bandwidth>10Mbps</Bandwidth>	<ConnectionList>	           <Switch>		<SWName>WM-Aggr</SWName>		<SWType>Aggregate Switch</SWType>		<SWID>0xabcde</SWID>		<UpPort>1</UpPort>		<DownPort>5</DownPort>	          </Switch>	          <Switch>		<SWName>WM-TOR</SWName>		<SWType>TOR Switch</SWType>		<SWID>0xdefgh</SWID>		<UpPort>3</UpPort>		<DownPort>4</DownPort>	          </Switch>	</ConnectionList></NetworkList></ResponseInfo>";
					System.out.println("Response from Cloud");
					System.out.println(responseXml);
					ResponseCreateCloudNetwork nwRes = getResponseCreateCloudNW(responseXml);

					// TODO: csdnCreateNWConnection 의 결과를 network_service_dc
					// 테이블에 입력
					// TODO: Insert into tables using nwRes
					printResponseCreateCloudNetwork(nwRes);
					updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
							totalCnt, "Cloud SDN에 요청한 Network가 생성되었습니다.");

				} else {
					reqDomain = 2; // Set Request Domain as Premise

					System.out.println("Request create Premise Network");
					RequestCreatePremiseNetwork req = new RequestCreatePremiseNetwork();
					req.setNetworkname(tn.getNwName());
					req.setTenantName(tn.getTenantName());
					req.setBandwidth(svcReq.getBandwidth());

					requestXml = getRequestCreatePremiseNWXML(req);

					res = requestToAPIServer(reqDomain, requestXml);

					updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
							totalCnt, "Premise SDN에 Network 생성을 요청하였습니다.");

					String responseXml = getResponseXml(res);
					ResponseCreatePremiseNetwork nwRes = getResponseCreatePremiseNW(responseXml);

					logger.info(nwRes.getReturnCode());
					updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
							totalCnt, "Premise SDN에 요청한 Network가 생성되었습니다.");

					// TODO: Insert into tables using nwRes
				}
			}

			updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
					totalCnt, "VLAN Swapping을 수행합니다.");
			vlanSwap("10.10.65.5", "10020", 21);
			vlanSwap("10.10.65.5", "10001", 11);

			reqDomain = 3; // Set Request Domain as Transport
			System.out.println("Request create Transport Network");
			requestXml = "<?xml version=\“1.0\” encoding=\“utf-8\” ?><Ethernet name=\“myEth\” description=\"DC to DC tunnel\">    <rid>REQ-123456</rid>    <cid>CUSTOMER-abcdefg</cid>    <eType>E-LAN</eType>    <UNIPeer id=\"switch1-ID\" port=\"10\" vlan=\"1001\"/>    <UNIPeer id=\"switch2-ID\" port=\"20\" vlan=\"1002\"/>    <UNIPeer id=\"switch3-ID\" port=\"30\" vlan=\"1003\"/>    <QoS bandwidth=\“1G\” exceed=\“100M\”/></Ethernet>";

			res = requestToAPIServer(reqDomain, requestXml);

			updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
					totalCnt, "Transport SDN에 Network 생성을 요청하였습니다.");

			String responseXml = getResponseXml(res);
			System.out.println(responseXml);
			updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
					totalCnt, "Transport SDN에 요청한 Network가 생성되었습니다.");

			updateProgressStatusTable(svcReq.getCustId(), ++currentCnt,
					totalCnt, "요청한 Network 생성이 완료 되었습니다.");

		} catch (Exception e) {
			e.printStackTrace();
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}
	}

	private ResponseCreatePremiseNetwork getResponseCreatePremiseNW(
			String responseXml) {
		ResponseCreatePremiseNetwork res = null;
		try {
			JAXBContext jaxbContext = JAXBContext
					.newInstance(ResponseCreatePremiseNetwork.class);

			Unmarshaller jaxbUnmarshaller = jaxbContext.createUnmarshaller();

			StringReader reader = new StringReader(responseXml);
			res = (ResponseCreatePremiseNetwork) jaxbUnmarshaller
					.unmarshal(reader);
		} catch (Exception e) {
			e.printStackTrace();
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}
		return res;
	}

	private ResponseCreateCloudNetwork getResponseCreateCloudNW(
			String responseXml) {
		ResponseCreateCloudNetwork res = null;
		try {
			JAXBContext jaxbContext = JAXBContext
					.newInstance(ResponseCreateCloudNetwork.class);

			Unmarshaller jaxbUnmarshaller = jaxbContext.createUnmarshaller();

			StringReader reader = new StringReader(responseXml);
			res = (ResponseCreateCloudNetwork) jaxbUnmarshaller
					.unmarshal(reader);
		} catch (Exception e) {
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}

		return res;
	}

	private String getResponseXml(HttpResponse res) {
		String responseXml = "";

		try {
			BufferedReader rd = new BufferedReader(new InputStreamReader(res
					.getEntity().getContent()));

			String line = "";
			StringBuffer jb = new StringBuffer();
			while ((line = rd.readLine()) != null) {
				jb.append(line);
			}
			responseXml = jb.toString();

		} catch (IOException e) {
			e.printStackTrace();
		}

		return responseXml;
	}

	private HttpResponse requestToAPIServer(int reqDomain, String requestXml) {
		String url = "";

		if (reqDomain == 1) {
			url = cloudUrl;
		} else if (reqDomain == 2) {
			url = premiseUrl;
		} else if (reqDomain == 3) {
			url = transportUrl;
		}

		HttpResponse res = null;
		try {
			HttpClient client = new DefaultHttpClient();

//			HttpGet req = new HttpGet(url);
			// HttpPost req = new HttpPost(url);
			// StringEntity entity = new StringEntity(requestXml);
			// req.setEntity(entity);

			HttpPost req = new HttpPost(url);
			StringEntity entity = new StringEntity(requestXml);
			req.setEntity(entity);

			// Get Response
			res = client.execute(req);
		} catch (java.net.NoRouteToHostException noroute) {
			String retMsg = "No Route To Host Exception: API Server is not responding";
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		} catch (Exception e) {
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}

		return res;
	}

	// Perform XML Marsharling of Request
	public String getRequestCreateCloudNWXML(RequestInfoCloudSDNConnnection req) {

		String requestXml = "";
		try {
			JAXBContext jaxbContext = JAXBContext
					.newInstance(RequestInfoCloudSDNConnnection.class);
			Marshaller jaxbMarshaller = jaxbContext.createMarshaller();

			jaxbMarshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);

			StringWriter writer = new StringWriter();
			jaxbMarshaller.marshal(req, writer);

			requestXml = writer.toString();
		} catch (JAXBException e) {
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}

		logger.debug(requestXml);
		return requestXml;
	}

	public String getRequestCreatePremiseNWXML(RequestCreatePremiseNetwork req) {

		String requestXml = "";
		try {
			JAXBContext jaxbContext = JAXBContext
					.newInstance(RequestCreatePremiseNetwork.class);
			Marshaller jaxbMarshaller = jaxbContext.createMarshaller();

			jaxbMarshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);

			StringWriter writer = new StringWriter();
			jaxbMarshaller.marshal(req, writer);

			requestXml = writer.toString();
		} catch (JAXBException e) {
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}

		logger.debug(requestXml);
		return requestXml;
	}

	// Insert received Network Service into DB
	public void updateNetworkServiceTable(String svcId,
			NetworkServiceRequest req) {
		String custName = "농협중앙회";

		NetworkService item = null;
		NetworkServiceDao networkDao = DaoFactory.getNetworkServiceDao();
		try {
			item = new NetworkService();

			// Customer Info
			item.setCustId(req.getCustId());
			item.setCustName(custName); // TODO: Customer Name should be passed
										// from Web or DB
			item.setContactPoint("010-xxx-xxxx"); // TODO: Customer contact
													// Point should be passed
													// from Web or DB
			item.setAddress("대전시 유성구 전민동 463-1"); // TODO: Customer address
													// should be passed from Web
													// or DB

			// Service Request
			item.setSvcId(svcId);

			Random random = new Random();
			item.setSvcName(custName + "-" + random.nextInt(1000));
			item.setSvctype(req.getServiceType());
			item.setTopologyType(req.getTopologyType());
			item.setConnType(req.getConnType());
			item.setBandwidth(Integer.parseInt(req.getBandwidth()));

			logger.info(req.getFromTime());
			Timestamp beginTime = Timestamp.valueOf(req.getFromTime() + ":00");
			Timestamp endTime = Timestamp.valueOf(req.getToTime() + ":00");

			item.setBeginTime(beginTime);
			item.setEndTime(endTime);

			networkDao.insertNetworkService(item);
		} catch (Exception e) {
			e.printStackTrace();
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}
	}

	// Insert received Network Service into DB
	private void updateProgressStatusTable(String custId, int currentCnt,
			int totalCnt, String msg) {
		ProgressStatusDao progressDao = DaoFactory.getProgressStatusDao();

		try {
			ProgressStatus progress = null;
			progress = progressDao.selectProgressStatusById(custId);

			if (progress == null) {
				progress = new ProgressStatus();

				progress.setCustid(custId);
				progress.setCurrentcnt(currentCnt);
				progress.setTotalcnt(totalCnt);
				progress.setProcessmsg(msg);

				progressDao.insertProgressStatus(progress);
			} else {
				progress.setCurrentcnt(currentCnt);
				progress.setTotalcnt(totalCnt);
				progress.setProcessmsg(msg);

				progressDao.updateProgressStatus(progress);
			}
			Thread.sleep(1000); // TODO: Remove later...
		} catch (Exception e) {
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}
	}

	private NetworkServiceRequest recvRequestfromWeb() {
		NetworkServiceRequest nsReq = null;
		try {
			nsReq = new NetworkServiceRequest();

			FieldBuffer inBuf = request.getFieldBuffer();

			String custId = inBuf.getString("CUSTID");
			String serviceType = inBuf.getString("SERVICETYPE");
			String topologyType = inBuf.getString("TOPOLOGYTYPE");
			String connType = inBuf.getString("CONNTYPE");
			String fromTime = inBuf.getString("FROMTIME");
			String toTime = inBuf.getString("TOTIME");
			String bandwidth = inBuf.getString("BANDWIDTH");

			nsReq.setCustId(custId);
			nsReq.setServiceType(serviceType);
			nsReq.setTopologyType(topologyType);
			nsReq.setConnType(connType);
			nsReq.setFromTime(fromTime);
			nsReq.setToTime(toTime);
			nsReq.setBandwidth(bandwidth);

			ArrayList<TenantNetworkInfo> tnInfoList = new ArrayList<TenantNetworkInfo>();

			int itemCnt = inBuf.getCount("GUBUN");
			System.out.println("Total number of items selected: " + itemCnt);
			for (int i = 0; i < itemCnt; i++) {
				TenantNetworkInfo tnInfo = new TenantNetworkInfo();

				tnInfo.setTenantName(inBuf.getString("TENANTNAME"));
				tnInfo.setNwName(inBuf.getString("NWNAME"));

				try {
					String dcId;
					String dcName;
					if ((dcId = inBuf.getString("DCID")) != null) {
						tnInfo.setDcId(dcId);
					}
					if ((dcName = inBuf.getString("DCNAME")) != null) {
						tnInfo.setDcName(dcName);
					}
				} catch (IndexOutOfBoundsException ioobe) {
					System.out.println(ioobe.getMessage());
				}

				if (tnInfoList == null) {
					System.out.println("tnInfoList is null");
				}

				tnInfoList.add(tnInfo);
				System.out.println("tnINfoList - add new tnInfo: "
						+ tnInfo.getNwName());
			}

			nsReq.setNetworklist(tnInfoList);

		} catch (Exception e) {
			e.printStackTrace();
			String retMsg = "" + e;
			response.setResultCode(-1);
			response.setResultMessage(retMsg);
		}

		return nsReq;
	}
}
